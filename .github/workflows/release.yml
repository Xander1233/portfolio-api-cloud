name: Build API

on:
  release:
    types:
      - "published"

  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to use (optional, e.g. v1.2.3)"
        required: false
        type: string
        default: ""

jobs:

  upload:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: Resolve release tag
        id: resolve
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          
          # 1) explicit manual input wins
          if [ -n "${{ inputs.tag }}" ]; then
            TAG="${{ inputs.tag }}"
            # Optional: validate it exists
            gh release view "$TAG" >/dev/null || { echo "Tag $TAG not found"; exit 1; }
            echo "tag=$TAG" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          # 2) release event
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "tag=${{ github.event.release.tag_name }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          # 3) manual with no input: grab latest release
          # First try latest non-prerelease
          TAG="$(gh api repos/${{ github.repository }}/releases/latest --jq .tag_name 2>/dev/null || true)"
          if [ -z "$TAG" ] || [ "$TAG" = "null" ]; then
            # Fallback: most recent published (including prereleases, excluding drafts)
            TAG="$(gh api repos/${{ github.repository }}/releases --paginate \
                   --jq 'map(select(.draft|not)) | sort_by(.published_at) | reverse | .[0].tag_name' \
                   | head -n1)"
          fi
          
          if [ -z "$TAG" ] || [ "$TAG" = "null" ]; then
            echo "No releases found in repo ${{ github.repository }}"; exit 1
          fi
          
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/checkout@v4

      - name: Build and push to harbor
        id: docker_build_push
        run: |
          docker build ./ \
            -t ghcr.io/xander1233/portfolio-api-cloud:latest \
            -t ghcr.io/xander1233/portfolio-api-cloud:${{ steps.resolve.outputs.tag }} \
          
          docker push ghcr.io/xander1233/portfolio-api-cloud --all-tags

      - name: Image digest
        run: echo ${{ steps.docker_build_push.outputs.digest }}